(()=>{let e=[],o=[],t=!1;chrome.webRequest.onResponseStarted.addListener((function(s){o.includes(s.tabId)&&s.url.includes(".ts")&s.initiator.includes("twitch.tv")&&(console.log(s),fetch(s.url).then((e=>e.blob())).then((n=>{if(n.size>1){if(t=!1,e.forEach((function(e){s.tabId==e.id&&(t=!0,e.blobs.push(n))})),!t){let o=new Object;o.id=s.tabId,o.blobs=[],o.blobs.push(n),e.push(o)}chrome.tabs.query({active:!0},(function(t){let s=[],n=0;e.forEach((function(e){e.blobs.forEach((function(e){n+=e.size})),s[e.id]=n,n=0})),console.log(e),chrome.tabs.query({},(function(e){for(var t=0;t<e.length;++t)o.includes(e[t].id)&&chrome.tabs.sendMessage(e[t].id,{method:"blobs",data:s[e[t].id]/1e6,data2:e[t].id})}))}))}})))}),{urls:["<all_urls>"]}),chrome.runtime.onMessage.addListener((function(t,s,n){if("start"==t.method)console.log("starting..."),o.push(s.tab.id),n({});else if("stop"==t.method){console.log("stopping...");var i=o.indexOf(s.tab.id);-1!==i&&o.splice(i,1),n({})}else"clean"==t.method?(console.log("cleaning..."),e.forEach((function(e){s.tab.id==e.id&&(e.blobs=[])})),e=[],n({})):"download"==t.method?(console.log("downloading..."),e.forEach((function(e){if(t.id.replace("video","")==e.id){console.log("downloading tabs id "+e.id),console.log(e.blobs.length+" ts parts");const o=new Blob(e.blobs);!async function(e,o,t=!0){const s=async(s,n)=>{s.postMessage({blob:e,name:o,close:n},t?[await e.arrayBuffer()]:[])},[n]=await self.clients.matchAll({type:"window"});if(n)return s(n);const i=chrome.runtime.getManifest().web_accessible_resources?.some((e=>e.resources?.includes("assets/downloader.html")))&&(await chrome.tabs.query({url:"*://*/*"})).find((e=>e.url));i?chrome.scripting.executeScript({target:{tabId:i.id},func:()=>{const e=document.createElement("iframe");e.src=chrome.runtime.getURL("assets/downloader.html"),e.style.cssText="display:none!important",document.body.appendChild(e)}}):chrome.windows.create({url:"assets/downloader.html",state:"minimized"}),self.addEventListener("message",(function e(o){"sendBlob"===o.data&&(self.removeEventListener("message",e),s(o.source,!i))}))}(new File([o],"video.mp4",{type:"video/mp4"}),"video.mp4",!1),n({})}}))):n({})}))})();